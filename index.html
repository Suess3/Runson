<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Run Tracker</title>
  <style>
    :root {
      --bg:#0f172a;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent-2:#38bdf8;
      --danger:#ef4444;
      --border:#1f2937;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin:0; }
    body {
      font-family: system-ui, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 70% -100px, #1f2937 0%, #0b1222 40%, var(--bg) 70%);
    }
    .container { max-width: 960px; margin:0 auto; padding:20px; }
    .nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#0b1222; color:var(--text); cursor:pointer; }
    .btn-primary { background:var(--accent); color:#000; }
    .card { background:rgba(255,255,255,0.02); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px; }
    label { display:block; margin-bottom:4px; color:var(--muted); }
    input, select, textarea { width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:#0a1326; color:var(--text); }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid var(--border); padding:8px; text-align:left; }
    th { color:#cbd5e1; }
    .num { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-variant-numeric: tabular-nums; white-space:nowrap; }
    .hidden { display:none; }
    .action-btn { background:transparent; border:1px solid var(--border); color:#e5e7eb; border-radius:6px; padding:4px 8px; cursor:pointer; }
    .action-btn:hover { background:#131c33; }
    /* Canvas styled by drawing code; border to match cards */
    canvas { width:100%; height:300px; display:block; background:#0a1326; border:1px solid var(--border); border-radius:10px; }
  </style>
</head>
<body>
<div class="container">
  <div class="nav">
    <h1>Run Tracker</h1>
    <div>
      <button class="btn" id="homeBtn">Home</button>
      <button class="btn" id="runBtn">Run</button>
      <button class="btn" id="statsBtn">Stats</button>
    </div>
  </div>

  <section id="view-home" class="card">
    <button class="btn btn-primary" onclick="Router.go('run')">Start a Run</button>
    <button class="btn" onclick="Router.go('stats')">View Stats</button>
  </section>

  <section id="view-run" class="card hidden">
    <label>Track</label>
    <select id="trackSelect"></select>
    <label>Distance (km)</label>
    <input id="distance" disabled>
    <label>Logged attempts</label>
    <input id="attempts" disabled>
    <label>Time (mm:ss)</label>
    <input id="timeInput" type="text" placeholder="e.g. 09:00">
    <label>Pace (min/km)</label>
    <input id="pace" disabled>
    <label>Date</label>
    <input id="dateAuto" disabled>
    <label>Note</label>
    <textarea id="noteInput" placeholder="optional"></textarea>
    <button class="btn btn-primary" id="saveRunBtn">Save Run</button>
    <div id="saveMsg" style="color:var(--muted)"></div>
  </section>

  <section id="view-stats" class="card hidden">
    <label>Track</label>
    <select id="trackStatsSelect"></select>
    <label>Goal (mm:ss)</label>
    <input id="goalInput" type="text" placeholder="09:00">
    <button class="btn" id="saveGoalBtn">Save Goal</button>
    <div>
      <p>Best: <span id="bestTime">–</span></p>
      <p>Average: <span id="avgTime">–</span></p>
      <p>Last: <span id="lastTime">–</span></p>
      <p>Gap to goal: <span id="gapToGoal">–</span></p>
    </div>
    <canvas id="chart" height="300"></canvas>
    <table>
      <thead><tr><th>Date</th><th>Time</th><th>Pace</th><th>Δ Goal</th><th>Note</th><th>Actions</th></tr></thead>
      <tbody id="runsTable"></tbody>
    </table>
  </section>
</div>
<script>
const LS_KEYS={tracks:'runlog.tracks',runs:'runlog.runs',goals:'runlog.goals'};
function loadJson(k,f){try{return JSON.parse(localStorage.getItem(k))??structuredClone(f);}catch{return structuredClone(f);}}
function saveJson(k,v){localStorage.setItem(k,JSON.stringify(v));}
function fmtDate(d){const dt=new Date(d);return dt.toLocaleDateString(undefined,{year:'numeric',month:'2-digit',day:'2-digit'});} 
function pad(n){return n.toString().padStart(2,'0');}
function fmtSec(s){if(!isFinite(s)||s<=0)return'–';return Math.floor(s/60)+":"+pad(Math.round(s%60));}
function parseTimeToSec(str){if(!str)return NaN; const s=String(str).trim().toLowerCase(); if(s.includes(':')){const p=s.split(':').map(Number); if(p.length===2) return p[0]*60+p[1]; if(p.length===3) return p[0]*3600+p[1]*60+p[2];}
  if(s.endsWith('s')) return parseFloat(s); const num=parseFloat(s.replace('min','').replace('m','')); return isNaN(num)?NaN:num*60;}
function pace(sec,km){return fmtSec(sec/km);} 

let state={tracks:loadJson(LS_KEYS.tracks,[]),runs:loadJson(LS_KEYS.runs,[]),goals:loadJson(LS_KEYS.goals,{})};
if(!state.tracks.length){state.tracks=[{id:'trattbergrunde',name:'Trattbergrunde',distanceKm:2.1},{id:'lemprunde',name:'Lemprunde',distanceKm:1.13}];saveJson(LS_KEYS.tracks,state.tracks);} 

const views={home:document.getElementById('view-home'),run:document.getElementById('view-run'),stats:document.getElementById('view-stats')};
const Router={go(v){location.hash=v;},current(){return location.hash.replace('#','')||'home';}};
window.addEventListener('hashchange',render);

a(document.getElementById('homeBtn'),'click',()=>Router.go('home'));
a(document.getElementById('runBtn'),'click',()=>Router.go('run'));
a(document.getElementById('statsBtn'),'click',()=>Router.go('stats'));

const trackSelect=document.getElementById('trackSelect');
const distanceInput=document.getElementById('distance');
const attemptsInput=document.getElementById('attempts');
const timeInput=document.getElementById('timeInput');
const paceInput=document.getElementById('pace');
const dateAuto=document.getElementById('dateAuto');
const noteInput=document.getElementById('noteInput');
const saveRunBtn=document.getElementById('saveRunBtn');
const saveMsg=document.getElementById('saveMsg');

const trackStatsSelect=document.getElementById('trackStatsSelect');
const goalInput=document.getElementById('goalInput');
const saveGoalBtn=document.getElementById('saveGoalBtn');
const runsTable=document.getElementById('runsTable');
const bestTimeEl=document.getElementById('bestTime');
const avgTimeEl=document.getElementById('avgTime');
const lastTimeEl=document.getElementById('lastTime');
const gapToGoalEl=document.getElementById('gapToGoal');
const chartCanvas=document.getElementById('chart');

function a(el,ev,fn){ el.addEventListener(ev,fn); }

function fillTracks(){const o=state.tracks.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');trackSelect.innerHTML=o;trackStatsSelect.innerHTML=o; if(!trackSelect.value && state.tracks[0]) trackSelect.value=state.tracks[0].id; if(!trackStatsSelect.value && state.tracks[0]) trackStatsSelect.value=state.tracks[0].id; }
function setRunDefaults(){const t=state.tracks.find(x=>x.id===trackSelect.value); if(!t) return; distanceInput.value=t.distanceKm; attemptsInput.value=state.runs.filter(r=>r.trackId===t.id).length; dateAuto.value=fmtDate(new Date());}
function updatePace(){const t=state.tracks.find(x=>x.id===trackSelect.value); if(!t) return; const sec=parseTimeToSec(timeInput.value); paceInput.value=isFinite(sec)? pace(sec,t.distanceKm):'–';}

a(timeInput,'input',updatePace);
a(trackSelect,'change',()=>{ setRunDefaults(); updatePace(); });

a(saveRunBtn,'click',()=>{const t=state.tracks.find(x=>x.id===trackSelect.value); const sec=parseTimeToSec(timeInput.value); if(!t){saveMsg.textContent='Pick a track';return;} if(!isFinite(sec)||sec<=0){saveMsg.textContent='Enter a valid time (e.g. 09:00)';return;} const run={id:crypto.randomUUID(),trackId:t.id,dateISO:new Date().toISOString(),timeSec:Math.round(sec),note:(noteInput.value||'').trim()}; state.runs.push(run); saveJson(LS_KEYS.runs,state.runs); timeInput.value=''; noteInput.value=''; setRunDefaults(); updatePace(); saveMsg.textContent='Saved'; setTimeout(()=>saveMsg.textContent='',2000); renderIfStats();});

a(saveGoalBtn,'click',()=>{const tId=trackStatsSelect.value; const sec=parseTimeToSec(goalInput.value); if(!isFinite(sec)||sec<=0){goalInput.focus();goalInput.select();return;} state.goals[tId]=Math.round(sec); saveJson(LS_KEYS.goals,state.goals); renderStats();});

function deleteRun(id){ const idx=state.runs.findIndex(r=>r.id===id); if(idx>=0){ state.runs.splice(idx,1); saveJson(LS_KEYS.runs,state.runs); renderStats(); setRunDefaults(); }}

function renderIfStats(){ if(Router.current()==='stats') renderStats(); }

function renderStats(){const t=state.tracks.find(x=>x.id===trackStatsSelect.value); if(!t) return; const goal=state.goals[t.id]??9*60; goalInput.value=fmtSec(goal);
  const runs=state.runs.filter(r=>r.trackId===t.id).sort((a,b)=>new Date(a.dateISO)-new Date(b.dateISO));
  if(!runs.length){bestTimeEl.textContent=avgTimeEl.textContent=lastTimeEl.textContent=gapToGoalEl.textContent='–'; runsTable.innerHTML=''; drawChart([], goal); return;}
  const times=runs.map(r=>r.timeSec); const best=Math.min(...times); const avg=Math.round(times.reduce((a,b)=>a+b,0)/times.length);
  bestTimeEl.textContent=fmtSec(best); avgTimeEl.textContent=fmtSec(avg); lastTimeEl.textContent=fmtSec(runs.at(-1).timeSec);
  const gap=best-goal; gapToGoalEl.textContent=(gap<=0?'✅ ':'+')+fmtSec(Math.abs(gap));
  runsTable.innerHTML=runs.map(r=>{ const delta=r.timeSec-goal; const deltaStr = delta===0? '0:00' : (delta>0? '+'+fmtSec(delta): '−'+fmtSec(-delta)); const color = delta>0? 'style="color:var(--danger)"':'style="color:var(--accent)"'; return `<tr>
      <td class="num">${fmtDate(r.dateISO)}</td>
      <td class="num">${fmtSec(r.timeSec)}</td>
      <td class="num">${pace(r.timeSec,t.distanceKm)}</td>
      <td class="num" ${color}>${deltaStr}</td>
      <td>${(r.note||'').replace(/</g,'&lt;')}</td>
      <td><button class="action-btn" data-del="${r.id}">Delete</button></td>
    </tr>`; }).join('');
  document.querySelectorAll('[data-del]').forEach(btn=>{ btn.addEventListener('click',()=>{ const id=btn.getAttribute('data-del'); if(confirm('Delete this entry?')) deleteRun(id); }); });
  drawChart(runs, goal);
}

// Chart with labels nudged right so they never clip
function drawChart(rows, goalSec){ const ctx=chartCanvas.getContext('2d'); const DPR=window.devicePixelRatio||1; const w=chartCanvas.clientWidth*DPR; const h=chartCanvas.clientHeight*DPR; if(chartCanvas.width!==w) chartCanvas.width=w; if(chartCanvas.height!==h) chartCanvas.height=h; ctx.clearRect(0,0,w,h);
  const padL=80, padR=18, padT=26, padB=46; const plotW=w-padL-padR, plotH=h-padT-padB;
  const times=rows.map(r=>r.timeSec);
  const minT=rows.length?Math.min(...times, goalSec):8*60; const maxT=rows.length?Math.max(...times, goalSec):14*60;
  const yMin=Math.max(0, Math.floor((minT-45)/30)*30); const yMax=Math.ceil((maxT+45)/30)*30;
  const X=i=> padL + (rows.length<=1? plotW/2 : i*(plotW/(rows.length-1)));
  const Y=s=> padT + (1 - (s - yMin)/(yMax-yMin)) * plotH;

  // grid
  ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=1*DPR; ctx.beginPath(); for(let s=yMin; s<=yMax; s+=30){ const yy=Y(s); ctx.moveTo(padL,yy); ctx.lineTo(w-padR,yy);} ctx.stroke();

  // y labels (to the RIGHT of y-axis start)
  ctx.fillStyle='rgba(229,231,235,0.95)'; ctx.font=`${12*DPR}px system-ui, sans-serif`; ctx.textAlign='left'; ctx.textBaseline='middle';
  for(let s=yMin; s<=yMax; s+=60){ ctx.fillText(fmtSec(s), padL+6, Y(s)); }

  // x labels
  ctx.textAlign='center'; ctx.textBaseline='top'; const step=Math.max(1, Math.floor(rows.length/6)); rows.forEach((r,i)=>{ if(i%step===0||i===rows.length-1){ ctx.fillText(fmtDate(r.dateISO), X(i), h-padB+6); }});

  // goal line
  ctx.strokeStyle='rgba(56,189,248,0.95)'; ctx.setLineDash([6*DPR,6*DPR]); ctx.beginPath(); ctx.moveTo(padL, Y(goalSec)); ctx.lineTo(w-padR, Y(goalSec)); ctx.stroke(); ctx.setLineDash([]);

  // path
  if(rows.length){ ctx.strokeStyle='rgba(34,197,94,0.95)'; ctx.lineWidth=2*DPR; ctx.beginPath(); rows.forEach((r,i)=>{ const xi=X(i), yi=Y(r.timeSec); if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi); }); ctx.stroke(); }

  // points
  rows.forEach((r,i)=>{ const xi=X(i), yi=Y(r.timeSec); ctx.fillStyle = r.timeSec<=goalSec? 'rgba(34,197,94,1)':'rgba(239,68,68,1)'; ctx.beginPath(); ctx.arc(xi,yi,3.6*DPR,0,Math.PI*2); ctx.fill(); });
}

function render(){Object.entries(views).forEach(([k,v])=>v.classList.toggle('hidden',k!==Router.current())); if(Router.current()==='run'){fillTracks(); setRunDefaults(); updatePace();} if(Router.current()==='stats'){fillTracks(); renderStats();}}

render();
window.addEventListener('resize', ()=>{ if(Router.current()==='stats') renderStats(); });
</script>
</body>
</html>
