<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Run Tracker (Minimal + Firebase)</title>

  <!-- Handwritten script font for background watermark -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#b5e6f5;
      --ink:#111; --muted:#555; --line:#cfcfcf; --accent:#0b57d0; --ok:#147a0a; --bad:#b00020;
      --wrap:max(320px, min(760px, 94vw));
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink); background:var(--bg);
      position:relative;
    }

    /* Background signature watermark, centered horizontally */
    body::after{
      content:"Made by Johannes";
      position:fixed;
      left:50%; bottom:14px; right:auto;
      transform:translateX(-50%) rotate(-2deg);
      font-family:"Great Vibes", cursive;
      font-size:clamp(28px, 6vw, 52px);
      color:#2d2d2d; opacity:.18;
      pointer-events:none;
      z-index:0;
      white-space:nowrap;
    }

    .wrap{max-width:var(--wrap); margin:0 auto; padding:12px; position:relative; z-index:1}
    header{display:flex; align-items:center; gap:10px; padding:6px 0 10px; border-bottom:1px solid var(--line); margin-bottom:12px}
    h1{font-size:18px; margin:0}
    .spacer{flex:1}

    .nav{display:flex; gap:6px; flex-wrap:wrap}
    .btn{appearance:none; -webkit-appearance:none; cursor:pointer; border:1px solid var(--line); background:#f8f8f8; color:var(--ink); padding:6px 10px; border-radius:6px; font-weight:600}
    .btn.primary{background:#e9f0ff; border-color:#bcd0ff; color:#0b3fb0}
    .btn.sm{padding:4px 8px; font-size:12px}
    .btn.danger{background:#ffecec; border-color:#f2b8b5; color:#b00020}

    /* Persistent sync chip */
    .chip{align-self:center; padding:4px 8px; border-radius:999px; border:1px solid #bfe3bf; background:#eaf7ea; color:#147a0a; font-weight:700; font-size:12px}
    .hidden{display:none !important}

    .panel{border:1px solid var(--line); border-radius:6px; padding:12px; background:#fff; margin-bottom:12px}

    label{display:block; margin:8px 0 4px; color:var(--muted); font-weight:600}
    input, select, textarea{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:6px; background:#fff; color:#000}
    textarea{min-height:80px; resize:vertical}

    .row{display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap}
    .grow{flex:1 1 160px}
    .muted{color:var(--muted)}

    /* Table */
    .table-wrap{overflow-x:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--line); border-radius:6px; background:#fff}
    table{width:100%; border-collapse:collapse; table-layout:auto; background:#fff}
    th, td{border-bottom:1px solid var(--line); padding:8px 10px; text-align:left; vertical-align:top}
    th{background:#fafafa}
    .num{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-variant-numeric: tabular-nums; white-space:nowrap}
    .col-date{min-width: 9ch}
    .col-time{min-width: 7ch}
    .col-pace{min-width: 8ch}
    .col-delta{min-width: 8ch}
    .col-note{min-width: 18ch}
    .col-act{min-width: 8ch}

    /* Chart + tooltip */
    .chart-wrap{position:relative}
    #chart{width:100%; height:260px; border:1px solid var(--line); border-radius:6px; background:#fff}
    #chartTip{
      position:fixed; z-index:20; display:none;
      background:rgba(17,17,17,.92); color:#fff;
      padding:6px 8px; border-radius:6px; font-size:12px; line-height:1.35;
      transform:translate(-50%, calc(-100% - 10px));
      pointer-events:none; white-space:nowrap;
      box-shadow:0 6px 18px rgba(0,0,0,.22);
    }

    .kpis{display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:8px}
    .kpi{border:1px solid var(--line); border-radius:6px; padding:10px; background:#fff}
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{font-weight:800; font-size:18px}

    @media (min-width: 820px){ body{font-size:16px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üèÉ‚Äç‚ôÇÔ∏è Run Tracker</h1>
      <div class="spacer"></div>
      <nav class="nav">
        <button class="btn" id="navHome">Home</button>
        <button class="btn" id="navRun">Run</button>
        <button class="btn" id="navStats">Stats</button>
        <button class="btn" id="navTracks">Tracks</button>
        <span id="syncChip" class="chip hidden" title="Connected to cloud">‚úì Synced</span>
      </nav>
    </header>

    <!-- HOME -->
    <section id="view-home" class="panel">
      <p class="muted" style="margin:0 0 8px">Data is stored locally by default. Enable cloud sync to access from all devices.</p>
      <details open>
        <summary style="cursor:pointer; font-weight:700">‚òÅÔ∏è Cloud Sync (Firebase Firestore)</summary>
        <p class="muted" style="margin:8px 0">Hint: you can use the sync code <strong>‚ÄúRun‚Äù</strong> to get started quickly. Use the same code on all devices.</p>
        <label for="syncCode">Sync code</label>
        <input id="syncCode" placeholder="e.g. Run" />
        <div class="row" style="margin-top:6px">
          <button class="btn primary" id="connectCloudBtn">Connect & Sync</button>
          <div id="cloudMsg" class="muted" style="padding-left:6px"></div>
        </div>
      </details>
    </section>

    <!-- RUN -->
    <section id="view-run" class="panel hidden">
      <div class="row">
        <div class="grow">
          <label for="trackSelect">Track</label>
          <select id="trackSelect"></select>
        </div>
        <div style="width:120px">
          <label for="distance">km</label>
          <input id="distance" disabled>
        </div>
        <div style="width:140px">
          <label for="attempts">logged</label>
          <input id="attempts" disabled>
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label for="timeInput">Time (mm:ss or mm ‚Äî also accepts 11:45 or 11.45)</label>
          <input id="timeInput" placeholder="e.g. 11:45 or 11.45">
        </div>
        <div class="grow">
          <label for="pace">Pace (min/km)</label>
          <input id="pace" disabled>
        </div>
        <div style="width:170px">
          <label for="dateInput">Date</label>
          <input id="dateInput" type="date">
        </div>
      </div>
      <label for="noteInput">Note</label>
      <textarea id="noteInput" placeholder="optional"></textarea>

      <div class="row" style="margin-top:6px">
        <button class="btn primary" id="saveRunBtn">Save run</button>
        <div id="saveMsg" class="muted" aria-live="polite" style="padding-left:6px"></div>
      </div>
    </section>

    <!-- STATS -->
    <section id="view-stats" class="panel hidden">
      <div class="row">
        <div class="grow">
          <label for="trackStatsSelect">Track</label>
          <select id="trackStatsSelect"></select>
        </div>
        <div class="grow">
          <label for="goalInput">Goal (mm:ss)</label>
          <div class="row">
            <input id="goalInput" placeholder="09:00" class="num"/>
            <button class="btn" id="saveGoalBtn">Save goal</button>
          </div>
        </div>
      </div>

      <div class="kpis" style="margin:8px 0 10px">
        <div class="kpi"><div class="label">Best</div><div class="value num" id="bestTime">‚Äì</div></div>
        <div class="kpi"><div class="label">Average</div><div class="value num" id="avgTime">‚Äì</div></div>
        <div class="kpi"><div class="label">Last</div><div class="value num" id="lastTime">‚Äì</div></div>
        <div class="kpi"><div class="label">Gap to goal</div><div class="value num" id="gapToGoal">‚Äì</div></div>
      </div>

      <div class="chart-wrap">
        <canvas id="chart" aria-label="Progress chart"></canvas>
        <div id="chartTip"></div>
      </div>

      <div class="table-wrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th class="col-date">Date</th>
              <th class="col-time">Time</th>
              <th class="col-pace">Pace</th>
              <th class="col-delta">Œî goal</th>
              <th class="col-note">Note</th>
              <th class="col-act">Delete</th>
            </tr>
          </thead>
          <tbody id="runsTable"></tbody>
        </table>
      </div>
    </section>

    <!-- TRACKS -->
    <section id="view-tracks" class="panel hidden">
      <h2 style="margin:0 0 8px">Tracks</h2>
      <div class="row">
        <div class="grow">
          <label for="newTrackName">Name</label>
          <input id="newTrackName" placeholder="e.g. Prater Runde">
        </div>
        <div style="width:160px">
          <label for="newTrackKm">Distance (km)</label>
          <input id="newTrackKm" placeholder="e.g. 5.00">
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn primary" id="addTrackBtn">Add track</button>
        <div id="trackMsg" class="muted" style="padding-left:6px"></div>
      </div>

      <div class="table-wrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th class="num">km</th>
              <th class="num">runs</th>
              <th class="col-act">Delete</th>
            </tr>
          </thead>
          <tbody id="tracksTable"></tbody>
        </table>
      </div>
    </section>
  </div>

<script type="module">
/***********************
 * Firebase (v12 modules)
 ***********************/
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/***********************
 * Config
 ***********************/
const firebaseConfig = {
  apiKey: "AIzaSyAHd5uyDJF7bKNjfJIRPGQuh7k2W6tDcE8",
  authDomain: "runson-83a3b.firebaseapp.com",
  projectId: "runson-83a3b",
  storageBucket: "runson-83a3b.firebasestorage.app",
  messagingSenderId: "659521632447",
  appId: "1:659521632447:web:ba3960e5c5b5494e77ae0a",
  measurementId: "G-08E9MT3JC3"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/***********************
 * App state + utilities
 ***********************/
const SC = globalThis.structuredClone || ((x)=>JSON.parse(JSON.stringify(x)));
const LS_KEYS = { tracks:'runlog.tracks', runs:'runlog.runs', goals:'runlog.goals', sync:'runlog.sync' };
const $ = sel => document.querySelector(sel);
const Router = { go(v){ location.hash = v; }, current(){ return location.hash.replace('#','') || 'home'; } };
window.addEventListener('hashchange', render);

function loadJson(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? SC(fallback); } catch{ return SC(fallback); } }
function saveJson(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function pad(n){ return String(n).padStart(2,'0'); }
function fmtSec(sec){ if(!isFinite(sec)||sec<=0) return '‚Äì'; const m=Math.floor(sec/60), s=Math.round(sec%60); return `${m}:${pad(s)}`; }

/* Parse "11:45" / "11.45" / "11,45" / "11min" / "90s" */
function parseTimeToSec(input){
  if(input == null) return NaN;
  const s = String(input).trim().toLowerCase();

  // hh:mm(:ss) or mm:ss
  if(s.includes(':')){
    const p = s.split(':').map(Number);
    if(p.length===2) return p[0]*60 + p[1];
    if(p.length===3) return p[0]*3600 + p[1]*60 + p[2];
  }

  // mm.ss or mm,ss -> interpret as mm:ss ONLY if seconds has exactly 2 digits (00..59)
  if(/[.,]/.test(s) && !/[a-z]/.test(s)){
    const parts = s.split(/[.,]/);
    if(parts.length===2){
      const mm = parseInt(parts[0],10);
      const ssStr = parts[1];
      if(/^\d{2}$/.test(ssStr)){
        const ss = parseInt(ssStr,10);
        if(ss >= 0 && ss < 60 && isFinite(mm)) return mm*60 + ss;
      }
    }
  }

  // "90s", "12m", "12min", plain number = minutes
  if(s.endsWith('s')) return parseFloat(s);
  const num = parseFloat(s.replace('min','').replace('m',''));
  return isNaN(num) ? NaN : num*60;
}

function fmtDate(d){ const dt=(d instanceof Date)? d : new Date(d); return dt.toLocaleDateString(undefined,{year:'numeric',month:'2-digit',day:'2-digit'}); }
function fmtMonth(d){
  const dt=(d instanceof Date)? d : new Date(d);
  const opts = { month:'short' };
  return dt.toLocaleDateString(undefined, opts);
}
function fmtMonthYear(d){
  const dt=(d instanceof Date)? d : new Date(d);
  const opts = { month:'short', year:'numeric' };
  return dt.toLocaleDateString(undefined, opts);
}
function ymd(d){ const dt=(d instanceof Date)? d : new Date(d); return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`; }
function paceMinPerKm(timeSec, km){ if(!isFinite(timeSec)||!isFinite(km)||km<=0) return '‚Äì'; return fmtSec(timeSec/km); }
function slugify(str){
  const base = String(str).normalize('NFKD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') || 'track';
  let id = base, n = 2;
  const existing = new Set(state.tracks.map(t=>t.id));
  while(existing.has(id)) id = `${base}-${n++}`;
  return id;
}

let state = {
  tracks: loadJson(LS_KEYS.tracks, []),
  runs:   loadJson(LS_KEYS.runs,   []), // {id, trackId, dateISO, timeSec, note}
  goals:  loadJson(LS_KEYS.goals,  {}), // map trackId -> goalSec
};

// Ensure default tracks exist
const defaults=[ {id:'trattbergrunde', name:'Trattbergrunde', distanceKm:2.1}, {id:'lemprunde', name:'Lemprunde', distanceKm:1.13} ];
if(!state.tracks.length){ state.tracks = defaults; saveJson(LS_KEYS.tracks, state.tracks); }
else { let changed=false; for(const t of defaults){ if(!state.tracks.find(x=>x.id===t.id)){ state.tracks.push(t); changed=true; } } if(changed) saveJson(LS_KEYS.tracks, state.tracks); }

/***************
 * View wiring
 ***************/
const views = {
  home:  $('#view-home'),
  run:   $('#view-run'),
  stats: $('#view-stats'),
  tracks:$('#view-tracks')
};
$('#navHome').onclick   = () => Router.go('home');
$('#navRun').onclick    = () => Router.go('run');
$('#navStats').onclick  = () => Router.go('stats');
$('#navTracks').onclick = () => Router.go('tracks');

const syncChip = $('#syncChip');

const trackSelect = $('#trackSelect');
const distanceInput = $('#distance');
const attemptsInput = $('#attempts');
const timeInput = $('#timeInput');
const paceInput = $('#pace');
const dateInput = $('#dateInput');
const noteInput = $('#noteInput');
const saveRunBtn = $('#saveRunBtn');
const saveMsg = $('#saveMsg');

const trackStatsSelect = $('#trackStatsSelect');
const goalInput = $('#goalInput');
const saveGoalBtn = $('#saveGoalBtn');
const runsTableBody = $('#runsTable');
const bestTimeEl = $('#bestTime');
const avgTimeEl = $('#avgTime');
const lastTimeEl = $('#lastTime');
const gapToGoalEl = $('#gapToGoal');
const chartCanvas = $('#chart');
const chartTip = $('#chartTip');

// Tracks view elements
const newTrackName = $('#newTrackName');
const newTrackKm = $('#newTrackKm');
const addTrackBtn = $('#addTrackBtn');
const trackMsg = $('#trackMsg');
const tracksTableBody = $('#tracksTable');

/***********************
 * Selects + defaults
 ***********************/
function fillTrackSelects(){
  const opts=state.tracks.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  trackSelect.innerHTML=opts;
  trackStatsSelect.innerHTML=opts;
}
function ensureSelectHasValue(sel, arr){ if(!sel.value && arr[0]) sel.value = arr[0].id; }
function setRunDefaults(){
  const t=state.tracks.find(x=>x.id===trackSelect.value);
  if(!t) return;
  distanceInput.value=t.distanceKm;
  attemptsInput.value=state.runs.filter(r=>r.trackId===t.id).length;
  dateInput.value = ymd(new Date());
  updatePacePreview();
}
function updatePacePreview(){
  const t=state.tracks.find(x=>x.id===trackSelect.value);
  const sec=parseTimeToSec(timeInput.value);
  paceInput.value=isFinite(sec) && t ? paceMinPerKm(sec, t.distanceKm) : '‚Äì';
}
timeInput.addEventListener('input', updatePacePreview);
trackSelect.addEventListener('change', setRunDefaults);

/***********************
 * Firebase sync
 ***********************/
let fb = { connected:false, code: (loadJson(LS_KEYS.sync,{code:''}).code||'').trim(), unsub:null, docRef:null };
const syncCodeInput = $('#syncCode');
const connectCloudBtn = $('#connectCloudBtn');
const cloudMsg = $('#cloudMsg');
if(!fb.code) fb.code = 'Run';
if(syncCodeInput) syncCodeInput.value = fb.code;

async function connectCloud(){
  fb.code = (syncCodeInput?.value||'').trim();
  if(!fb.code){ cloudMsg.textContent = 'Enter a sync code.'; return; }
  saveJson(LS_KEYS.sync, { code: fb.code });
  try{
    await signInAnonymously(auth);
    fb.docRef = doc(db, 'runtracker', fb.code);
    if(fb.unsub) fb.unsub();
    fb.unsub = onSnapshot(fb.docRef, snap => {
      if(!snap.exists()){
        setDoc(fb.docRef, { tracks: state.tracks, runs: state.runs, goals: state.goals, updatedAt: serverTimestamp() });
        cloudMsg.textContent = 'Created cloud doc. Synced.'; setTimeout(()=>cloudMsg.textContent='', 1800);
      }else{
        const cloud = snap.data();
        if(cloud && cloud.tracks && cloud.runs && cloud.goals){
          state.tracks = cloud.tracks; state.runs = cloud.runs; state.goals = cloud.goals;
          saveJson(LS_KEYS.tracks, state.tracks);
          saveJson(LS_KEYS.runs, state.runs);
          saveJson(LS_KEYS.goals, state.goals);
          render();
          cloudMsg.textContent = 'Synced from cloud.'; setTimeout(()=>cloudMsg.textContent='', 1200);
        }
      }
      // Show persistent synced chip after listener is live (and first snapshot processed)
      fb.connected = true;
      syncChip.classList.remove('hidden');
    });
  }catch(e){
    cloudMsg.textContent = 'Cloud error: '+(e?.message||e);
  }
}
async function pushToCloud(){
  if(!fb.connected || !fb.docRef) return;
  try{
    await setDoc(
      fb.docRef,
      { tracks: state.tracks, runs: state.runs, goals: state.goals, updatedAt: serverTimestamp() },
      { merge:true }
    );
  }catch(e){ console.warn('pushToCloud', e); }
}
connectCloudBtn?.addEventListener('click', connectCloud);

/***********************
 * Save run + goal + delete run
 ***********************/
saveRunBtn.addEventListener('click', async ()=>{
  const t=state.tracks.find(x=>x.id===trackSelect.value);
  const sec=parseTimeToSec(timeInput.value);
  if(!t){ saveMsg.textContent='Select a track'; return; }
  if(!isFinite(sec)||sec<=0){ saveMsg.textContent='Enter a valid time (e.g. 11:45 or 11.45)'; return; }
  const when = dateInput.value ? new Date(dateInput.value+'T12:00:00') : new Date();
  const entry={ id:(crypto.randomUUID?.()||Date.now()+''), trackId:t.id, dateISO:when.toISOString(), timeSec:Math.round(sec), note:(noteInput.value||'').trim() };
  state.runs.push(entry); saveJson(LS_KEYS.runs, state.runs);
  await pushToCloud();
  timeInput.value=''; noteInput.value=''; setRunDefaults(); saveMsg.textContent='Saved ‚úì'; setTimeout(()=> saveMsg.textContent='', 1800);
});

saveGoalBtn.addEventListener('click', async ()=>{
  const id=trackStatsSelect.value;
  const sec=parseTimeToSec(goalInput.value);
  if(!isFinite(sec)||sec<=0){ goalInput.focus(); goalInput.select(); return; }
  state.goals[id]=Math.round(sec); saveJson(LS_KEYS.goals, state.goals);
  await pushToCloud(); renderStats();
});

/* Delete run entry (with confirm) */
runsTableBody.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-del]');
  if(!btn) return;
  const id = btn.getAttribute('data-del');
  const run = state.runs.find(r=>r.id===id);
  if(!run) return;
  if(!confirm(`Delete entry on ${fmtDate(run.dateISO)} (${fmtSec(run.timeSec)})?`)) return;
  state.runs = state.runs.filter(r=>r.id!==id);
  saveJson(LS_KEYS.runs, state.runs);
  await pushToCloud();
  renderStats();
  setRunDefaults();
});

/***********************
 * Tracks: add + list + delete
 ***********************/
function renderTracks(){
  const rows = state.tracks.map(t=>{
    const count = state.runs.filter(r=>r.trackId===t.id).length;
    return `<tr>
      <td>${t.name}</td>
      <td class="num">${t.distanceKm}</td>
      <td class="num">${count}</td>
      <td class="col-act"><button class="btn sm danger" data-del-track="${t.id}">Delete</button></td>
    </tr>`;
  }).join('');
  tracksTableBody.innerHTML = rows || `<tr><td colspan="4" class="muted">No tracks yet.</td></tr>`;
}
addTrackBtn?.addEventListener('click', async ()=>{
  const name = (newTrackName.value||'').trim();
  const km = parseFloat((newTrackKm.value||'').replace(',','.'));
  if(!name){ trackMsg.textContent='Enter a name.'; return; }
  if(!(km>0)){ trackMsg.textContent='Enter a valid distance in km.'; return; }
  const id = slugify(name);
  state.tracks.push({ id, name, distanceKm: km });
  saveJson(LS_KEYS.tracks, state.tracks);
  await pushToCloud();
  newTrackName.value=''; newTrackKm.value=''; trackMsg.textContent='Track added ‚úì'; setTimeout(()=>trackMsg.textContent='', 1600);
  fillTrackSelects(); ensureSelectHasValue(trackSelect, state.tracks); ensureSelectHasValue(trackStatsSelect, state.tracks);
  renderTracks(); setRunDefaults(); renderStats();
});
tracksTableBody.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-del-track]');
  if(!btn) return;
  const id = btn.getAttribute('data-del-track');
  const trk = state.tracks.find(t=>t.id===id);
  if(!trk) return;
  if(!confirm(`Delete track "${trk.name}" and all its runs?`)) return;

  // Remove track, its runs, and its goal
  state.tracks = state.tracks.filter(t=>t.id!==id);
  state.runs   = state.runs.filter(r=>r.trackId!==id);
  delete state.goals[id];

  saveJson(LS_KEYS.tracks, state.tracks);
  saveJson(LS_KEYS.runs,   state.runs);
  saveJson(LS_KEYS.goals,  state.goals);
  await pushToCloud();

  // Refresh UI & selections
  fillTrackSelects();
  ensureSelectHasValue(trackSelect, state.tracks);
  ensureSelectHasValue(trackStatsSelect, state.tracks);
  setRunDefaults(); renderStats(); renderTracks();
  trackMsg.textContent='Track deleted ‚úì'; setTimeout(()=>trackMsg.textContent='', 1600);
});

/***********************
 * Stats rendering + chart (time-based spacing + smart labels)
 ***********************/
let chartPoints = []; // [{x,y, row}]
function renderStats(){
  const t=state.tracks.find(x=>x.id===trackStatsSelect.value);
  if(!t){
    runsTableBody.innerHTML='';
    bestTimeEl.textContent=avgTimeEl.textContent=lastTimeEl.textContent=gapToGoalEl.textContent='‚Äì';
    drawChart([], 9*60); return;
  }
  const goal = state.goals[t.id] ?? 9*60;
  goalInput.value = fmtSec(goal);

  const rows = state.runs.filter(r=>r.trackId===t.id).sort((a,b)=> new Date(a.dateISO)-new Date(b.dateISO));
  if(!rows.length){
    bestTimeEl.textContent=avgTimeEl.textContent=lastTimeEl.textContent=gapToGoalEl.textContent='‚Äì';
    runsTableBody.innerHTML=''; drawChart([], goal); return;
  }
  const times=rows.map(r=>r.timeSec);
  const best=Math.min(...times);
  const avg=Math.round(times.reduce((x,y)=>x+y,0)/times.length);
  bestTimeEl.textContent=fmtSec(best);
  avgTimeEl.textContent=fmtSec(avg);
  lastTimeEl.textContent=fmtSec(rows[rows.length-1].timeSec);
  const gap = best - goal; gapToGoalEl.textContent = (gap<=0? '‚úÖ ':'+') + fmtSec(Math.abs(gap));

  runsTableBody.innerHTML = rows.map(r=>{
    const d=fmtDate(r.dateISO);
    const tm=fmtSec(r.timeSec);
    const pc=paceMinPerKm(r.timeSec,t.distanceKm);
    const delta=r.timeSec-goal;
    const ds = delta===0 ? '0:00' : (delta>0? '+'+fmtSec(delta) : '‚àí'+fmtSec(-delta));
    const color = delta>0? 'style="color: var(--bad)"' : 'style="color: var(--ok)"';
    const note = (r.note||'').replace(/</g,'&lt;');
    return `<tr>
      <td class="col-date">${d}</td>
      <td class="num col-time">${tm}</td>
      <td class="num col-pace">${pc}</td>
      <td class="num col-delta" ${color}>${ds}</td>
      <td class="col-note">${note}</td>
      <td class="col-act"><button class="btn sm danger" data-del="${r.id}">Delete</button></td>
    </tr>`;
  }).join('');

  drawChart(rows, goal);
}

// Draw chart with dynamic left padding + time-based X spacing + smart X labels
function drawChart(rows, goalSec){
  const ctx=chartCanvas.getContext('2d');
  const DPR=window.devicePixelRatio||1;

  const w=Math.max(1, chartCanvas.clientWidth*DPR);
  const h=Math.max(1, chartCanvas.clientHeight*DPR);
  if(chartCanvas.width!==w) chartCanvas.width=w;
  if(chartCanvas.height!==h) chartCanvas.height=h;
  ctx.clearRect(0,0,w,h);

  // Y range
  const times=rows.map(r=>r.timeSec);
  const minT=rows.length?Math.min(...times, goalSec):8*60;
  const maxT=rows.length?Math.max(...times, goalSec):14*60;
  const y0=Math.max(0, Math.floor((minT-45)/30)*30);
  const y1=Math.ceil((maxT+45)/30)*30;

  // Compute widest Y label
  const labels=[];
  for(let s=y0; s<=y1; s+=60) labels.push(fmtSec(s));
  ctx.save();
  ctx.font=`${11*DPR}px system-ui, sans-serif`;
  let maxLabelW=0;
  for(const txt of labels){ const m=ctx.measureText(txt); if(m.width>maxLabelW) maxLabelW=m.width; }
  ctx.restore();

  const padL = Math.ceil(maxLabelW + 14*DPR);
  const padR = 16*DPR, padT = 22*DPR, padB = 52*DPR;
  const pw=w-padL-padR, ph=h-padT-padB;
  const Y=s => padT + (1 - (s - y0)/(y1 - y0)) * ph;

  // Time-based X mapping
  let X;
  if(rows.length<=1){
    X = _i => padL + pw/2;
  }else{
    const t0 = new Date(rows[0].dateISO).getTime();
    const t1 = new Date(rows[rows.length-1].dateISO).getTime();
    const range = Math.max(1, t1 - t0);
    X = (i) => {
      const ti = new Date(rows[i].dateISO).getTime();
      const frac = (ti - t0) / range;
      return padL + frac * pw;
    };
  }

  // Background grid (horizontal)
  ctx.save();
  ctx.translate(0.5*DPR,0.5*DPR);
  ctx.strokeStyle='#e5e5e5'; ctx.lineWidth=1*DPR;
  ctx.beginPath();
  for(let s=y0; s<=y1; s+=60){ const yy=Y(s); ctx.moveTo(padL,yy); ctx.lineTo(w-padR,yy); }
  ctx.stroke();
  ctx.restore();

  // Y labels
  ctx.fillStyle='#333';
  ctx.font=`${11*DPR}px system-ui, sans-serif`;
  ctx.textAlign='right'; ctx.textBaseline='middle';
  for(let s=y0; s<=y1; s+=60){ ctx.fillText(fmtSec(s), padL - 6*DPR, Y(s)); }

  // X labels: smart (dates vs months if too dense)
  const xs = rows.map((_,i)=>X(i));
  let minDx = Infinity;
  for(let i=1;i<xs.length;i++) minDx = Math.min(minDx, xs[i]-xs[i-1]);
  const minDxCss = minDx / DPR;
  const overlap = minDxCss < 60; // threshold for switching to months

  ctx.textAlign='center'; ctx.textBaseline='top';
  ctx.fillStyle='#333';
  if(!overlap){
    // Sparse date labels every ~N points
    const step=Math.max(1, Math.floor(rows.length/6));
    rows.forEach((r,i)=>{ if(i%step===0 || i===rows.length-1){ ctx.fillText(fmtDate(r.dateISO), xs[i], h-padB+6*DPR); }});
  }else{
    // Month labels at month boundaries
    let prevMonth = -1, prevYear = -1;
    rows.forEach((r,i)=>{
      const d = new Date(r.dateISO);
      const m = d.getMonth(), y = d.getFullYear();
      if(m!==prevMonth || y!==prevYear){
        const label = (m===0) ? fmtMonthYear(d) : fmtMonth(d);
        ctx.fillText(label, xs[i], h-padB+6*DPR);
        prevMonth = m; prevYear = y;
      }
    });
  }

  // Goal line (dashed)
  ctx.strokeStyle='#7aa2ff'; ctx.setLineDash([6*DPR,6*DPR]);
  ctx.beginPath(); ctx.moveTo(padL, Y(goalSec)); ctx.lineTo(w-padR, Y(goalSec)); ctx.stroke();
  ctx.setLineDash([]);

  // Run path
  if(rows.length){
    ctx.strokeStyle='#147a0a'; ctx.lineWidth=2*DPR;
    ctx.beginPath();
    rows.forEach((r,i)=>{ const xi=xs[i], yi=Y(r.timeSec); if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi); });
    ctx.stroke();
  }

  // Points (store for hit-testing)
  chartPoints = [];
  rows.forEach((r,i)=>{
    const xi=xs[i], yi=Y(r.timeSec);
    ctx.fillStyle = r.timeSec<=goalSec? '#147a0a' : '#b00020';
    ctx.beginPath(); ctx.arc(xi,yi,3.8*DPR,0,Math.PI*2); ctx.fill();
    chartPoints.push({ x: xi, y: yi, row: r });
  });
}

/***************
 * Chart interactions (tooltip on points)
 ***************/
function findNearestPoint(clientX, clientY){
  const DPR = window.devicePixelRatio||1;
  const rect = chartCanvas.getBoundingClientRect();
  const mx = (clientX - rect.left) * DPR;
  const my = (clientY - rect.top) * DPR;
  let best = null, bestDist = Infinity;
  for(const p of chartPoints){
    const dx = p.x - mx, dy = p.y - my;
    const d2 = dx*dx + dy*dy;
    if(d2 < bestDist){ bestDist = d2; best = p; }
  }
  const r = 9 * DPR; // hit radius
  return (best && Math.sqrt(bestDist) <= r) ? best : null;
}
chartCanvas.addEventListener('mousemove', (e)=>{
  const hit = findNearestPoint(e.clientX, e.clientY);
  chartCanvas.style.cursor = hit ? 'pointer' : 'default';
});
chartCanvas.addEventListener('click', (e)=>{
  const hit = findNearestPoint(e.clientX, e.clientY);
  if(!hit){ chartTip.style.display='none'; return; }
  const d = new Date(hit.row.dateISO);
  const detail = `${d.toLocaleDateString()} ‚Ä¢ ${fmtSec(hit.row.timeSec)} ‚Ä¢ pace ${paceMinPerKm(hit.row.timeSec, (state.tracks.find(t=>t.id===hit.row.trackId)||{}).distanceKm || 1)}/km`;
  chartTip.textContent = detail;
  chartTip.style.left = `${e.clientX}px`;
  chartTip.style.top  = `${e.clientY}px`;
  chartTip.style.display = 'block';
});
chartCanvas.addEventListener('mouseleave', ()=>{ chartTip.style.display='none'; });
window.addEventListener('scroll', ()=>{ chartTip.style.display='none'; }, {passive:true});

/***********************
 * Render router
 ***********************/
function render(){
  const cur=Router.current();
  Object.entries(views).forEach(([k,el])=> el.classList.toggle('hidden', k!==cur));
  if(cur==='run'){
    fillTrackSelects(); ensureSelectHasValue(trackSelect, state.tracks); setRunDefaults();
  }else if(cur==='stats'){
    fillTrackSelects(); ensureSelectHasValue(trackStatsSelect, state.tracks); renderStats();
  }else if(cur==='tracks'){
    renderTracks();
  }
}

// Boot
render();
connectCloud(); // auto-connect with saved/default code
window.addEventListener('resize', ()=>{ if(Router.current()==='stats') renderStats(); chartTip.style.display='none'; });
</script>
</body>
</html>
