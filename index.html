<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1222" />
  <title>Run Tracker ‚Äî Trattbergrunde & Lemprunde</title>
  <style>
    /* =====================
       MOBILE‚ÄëFIRST DESIGN
       ===================== */
    :root {
      --bg: #0b1222;          /* deep indigo */
      --bg2:#0f172a;          /* slate */
      --card:#0d1428;         /* panel */
      --muted:#96a3b8;        /* slate-400 */
      --text:#e6e7eb;         /* gray-200 */
      --accent:#22c55e;       /* green-500 */
      --accent-2:#38bdf8;     /* sky-400 */
      --danger:#ef4444;       /* red-500 */
      --border:#1f2937;       /* gray-800 */
      --radius: 14px;
      --space: 14px;
      --container-w: min(100%, 720px);
      --vh: 100vh;            /* updated via JS for mobile chrome */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      /* responsive background that subtly adapts to height */
      background: radial-gradient(1200px 60vh at 70% -20vh, var(--bg2) 0%, #0b1222 40%, var(--bg) 70%);
      background-attachment: fixed;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7fafc; --bg2:#e9eef6; --card:#ffffff; --text:#0f172a; --muted:#475569; --border:#e5e7eb; }
      body{ background: linear-gradient(180deg, var(--bg2), var(--bg)); }
    }

    /* layout */
    .wrap { max-width: var(--container-w); margin: 0 auto; padding: calc(var(--space) * 1.2); }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom: var(--space); }
    .title { font-size: clamp(18px, 5vw, 22px); margin:0; font-weight:700; letter-spacing:.2px; }
    .subtle { color: var(--muted); font-weight:500; }

    .tabs { display:flex; gap:8px; }
    .btn { -webkit-tap-highlight-color: transparent; cursor:pointer; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:600; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background:linear-gradient(180deg, #176236, #0f4a29); border-color:#174b2f; }

    .card { background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border:1px solid var(--border); border-radius: var(--radius); padding: calc(var(--space) * 1.1); box-shadow: 0 10px 30px rgba(0,0,0,.28); }

    .stack { display:flex; flex-direction:column; gap: 12px; }
    .row { display:flex; gap: 12px; }
    .row.wrap { flex-wrap: wrap; }
    .grow { flex: 1 1 160px; }

    label { font-size: 12px; color: var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea { width:100%; padding:12px; border-radius:12px; background: #0a1326; color: var(--text); border:1px solid var(--border); outline:none; }
    textarea { resize: vertical; min-height: 84px; }

    /* form width caps to avoid edge-to-edge stretching on phones */
    .cap { max-width: 520px; }
    .cap-sm { max-width: 360px; }

    .pill { align-self:flex-start; font-size:12px; color:var(--muted); border:1px solid var(--border); background:#0b1222; padding:8px 10px; border-radius:999px; }

    /* table (stats) */
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align:left; }

    /* chart responsive height */
    #chart { width:100%; height: 32vh; min-height: 230px; max-height: 420px; display:block; border:1px solid var(--border); border-radius: var(--radius); background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00)); }

    .legend { display:flex; gap:12px; align-items:center; flex-wrap: wrap; margin-top: 6px; font-size:12px; color:var(--muted); }
    .dot { width:10px; height:10px; border-radius: 50%; display:inline-block; }

    .footer { color:var(--muted); font-size:12px; margin-top: 12px; text-align:center; }

    /* larger screens: gently center and widen */
    @media (min-width: 760px){
      .wrap { padding: 24px; }
      .card { padding: 18px; }
      #chart { height: 360px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="nav">
      <h1 class="title">üèÉ‚Äç‚ôÇÔ∏è Run Tracker <span class="subtle">Trattbergrunde 2.1 km ‚Ä¢ Lemprunde 1.13 km</span></h1>
      <nav class="tabs">
        <button class="btn" id="homeBtn">Home</button>
        <button class="btn" id="runBtn">Run</button>
        <button class="btn" id="statsBtn">Stats</button>
      </nav>
    </header>

    <!-- HOME -->
    <section id="view-home" class="card stack">
      <div class="pill">Start</div>
      <button class="btn btn-primary" onclick="Router.go('run')">‚ûï Start a run</button>
      <button class="btn" onclick="Router.go('stats')">üìä See stats</button>
    </section>

    <!-- RUN -->
    <section id="view-run" class="card stack hidden">
      <span class="pill">‚õ∞Ô∏è Track</span>
      <div class="row wrap cap">
        <div class="grow cap-sm">
          <label for="trackSelect">Track</label>
          <select id="trackSelect"></select>
        </div>
        <div class="grow cap-sm">
          <label for="distance">Distance (km)</label>
          <input id="distance" type="number" step="0.01" min="0" disabled />
        </div>
        <div class="grow cap-sm">
          <label for="attempts">Logged attempts</label>
          <input id="attempts" type="number" disabled />
        </div>
      </div>

      <span class="pill">‚è±Ô∏è Log a run</span>
      <div class="row wrap cap">
        <div class="grow cap-sm">
          <label for="timeInput">Time (mm:ss or mm)</label>
          <input id="timeInput" type="text" inputmode="numeric" placeholder="e.g. 09:00" />
        </div>
        <div class="grow cap-sm">
          <label for="pace">Pace (min/km)</label>
          <input id="pace" type="text" disabled />
        </div>
        <div class="grow cap-sm">
          <label for="dateAuto">Date</label>
          <input id="dateAuto" type="text" disabled />
        </div>
      </div>
      <div class="cap">
        <label for="noteInput">Note (optional)</label>
        <textarea id="noteInput" placeholder="Why was today fast/slow?"></textarea>
      </div>
      <div class="row cap">
        <button class="btn btn-primary" id="saveRunBtn">Save run</button>
        <div id="saveMsg" class="subtle" aria-live="polite" style="align-self:center"></div>
      </div>
    </section>

    <!-- STATS -->
    <section id="view-stats" class="card stack hidden">
      <span class="pill">üìä Stats</span>
      <div class="row wrap cap">
        <div class="grow cap-sm">
          <label for="trackStatsSelect">Track</label>
          <select id="trackStatsSelect"></select>
        </div>
        <div class="grow cap-sm">
          <label for="goalInput">Goal time (mm:ss)</label>
          <div class="row">
            <input class="grow" id="goalInput" type="text" placeholder="09:00" />
            <button class="btn" id="saveGoalBtn">Set</button>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="row wrap cap">
        <div class="grow card" style="padding:12px; background:#0a1226;">
          <div class="subtle" style="font-size:12px;">Best time</div>
          <div style="font-weight:800; font-size:20px;" id="bestTime">‚Äì</div>
        </div>
        <div class="grow card" style="padding:12px; background:#0a1226;">
          <div class="subtle" style="font-size:12px;">Average time</div>
          <div style="font-weight:800; font-size:20px;" id="avgTime">‚Äì</div>
        </div>
        <div class="grow card" style="padding:12px; background:#0a1226;">
          <div class="subtle" style="font-size:12px;">Last run</div>
          <div style="font-weight:800; font-size:20px;" id="lastTime">‚Äì</div>
        </div>
        <div class="grow card" style="padding:12px; background:#0a1226;">
          <div class="subtle" style="font-size:12px;">Gap to goal</div>
          <div style="font-weight:800; font-size:20px;" id="gapToGoal">‚Äì</div>
        </div>
      </div>

      <!-- Chart -->
      <canvas id="chart" aria-label="Progress chart"></canvas>
      <div class="legend">
        <span class="dot" style="background:var(--accent)"></span>Run
        <span class="dot" style="background:var(--accent-2)"></span>Goal
        <span class="dot" style="background:var(--danger)"></span>Above goal
        <span class="dot" style="background:var(--accent)"></span>At/under goal
      </div>

      <!-- Table -->
      <div class="card" style="background:#0a1226;">
        <div class="subtle" style="margin-bottom:8px;">All entries</div>
        <div style="overflow:auto; -webkit-overflow-scrolling: touch;">
          <table id="runsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Pace</th>
                <th>Œî goal</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <p class="footer">Data stays on your phone (localStorage). Single file, offline ready.</p>
  </div>

<script>
/* Viewport height fix for mobile browsers */
function setVH(){
  document.documentElement.style.setProperty('--vh', window.innerHeight + 'px');
}
setVH();
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', setVH);

/* ---------------- Utilities ---------------- */
const LS_KEYS = { tracks:'runlog.tracks', runs:'runlog.runs', goals:'runlog.goals' };
const $ = sel => document.querySelector(sel);

function loadJson(key, fallback) { try { return JSON.parse(localStorage.getItem(key)) ?? structuredClone(fallback); } catch { return structuredClone(fallback); } }
function saveJson(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

function fmtDate(d){ const dt = (d instanceof Date) ? d : new Date(d); return dt.toLocaleDateString(undefined,{year:'numeric',month:'2-digit',day:'2-digit'}); }
function pad(n){ return n.toString().padStart(2,'0'); }
function fmtSec(sec){ if(!isFinite(sec)||sec<=0) return '‚Äì'; const m=Math.floor(sec/60), s=Math.round(sec%60); return `${m}:${pad(s)}`; }
function parseTimeToSec(input){ if(!input) return NaN; const s=String(input).trim().toLowerCase(); if(s.includes(':')){ const p=s.split(':').map(Number); if(p.length===2) return p[0]*60+p[1]; if(p.length===3) return p[0]*3600+p[1]*60+p[2]; } if(s.endsWith('s')) return parseFloat(s); const num=parseFloat(s.replace('min','').replace('m','')); return isNaN(num)?NaN:num*60; }
function paceMinPerKm(timeSec, km){ if(!isFinite(timeSec)||!isFinite(km)||km<=0) return '‚Äì'; return fmtSec(timeSec/km); }

/* ---------------- Data ---------------- */
let state = { tracks: loadJson(LS_KEYS.tracks, []), runs: loadJson(LS_KEYS.runs, []), goals: loadJson(LS_KEYS.goals, {}) };

// Ensure both tracks exist (without nuking existing data)
const defaults = [
  { id:'trattbergrunde', name:'Trattbergrunde', distanceKm:2.1 },
  { id:'lemprunde', name:'Lemprunde', distanceKm:1.13 },
];
if(!state.tracks.length){
  state.tracks = defaults;
  saveJson(LS_KEYS.tracks, state.tracks);
}else{
  // add any missing default tracks
  let changed=false;
  for(const t of defaults){ if(!state.tracks.find(x=>x.id===t.id)){ state.tracks.push(t); changed=true; } }
  if(changed) saveJson(LS_KEYS.tracks, state.tracks);
}

/* ---------------- Routing ---------------- */
const views = { home: $('#view-home'), run: $('#view-run'), stats: $('#view-stats') };
const Router = { go(view){ location.hash=view; }, current(){ return location.hash.replace('#','')||'home'; } };
window.addEventListener('hashchange', render);

/* ---------------- Elements ---------------- */
const trackSelect = $('#trackSelect');
const distanceInput = $('#distance');
const attemptsInput = $('#attempts');
const timeInput = $('#timeInput');
const paceInput = $('#pace');
const dateAuto = $('#dateAuto');
const noteInput = $('#noteInput');
const saveRunBtn = $('#saveRunBtn');
const saveMsg = $('#saveMsg');

const trackStatsSelect = $('#trackStatsSelect');
const goalInput = $('#goalInput');
const saveGoalBtn = $('#saveGoalBtn');
const runsTableBody = $('#runsTable tbody');
const bestTimeEl = $('#bestTime');
const avgTimeEl = $('#avgTime');
const lastTimeEl = $('#lastTime');
const gapToGoalEl = $('#gapToGoal');
const chartCanvas = $('#chart');

/* ---------------- Fill & Defaults ---------------- */
function fillTrackSelects(){ const opts = state.tracks.map(t=>`<option value="${t.id}">${t.name}</option>`).join(''); trackSelect.innerHTML=opts; trackStatsSelect.innerHTML=opts; }
function setRunTrackDefaults(){ const t = state.tracks.find(t=>t.id===trackSelect.value); if(!t) return; distanceInput.value=t.distanceKm; attemptsInput.value=state.runs.filter(r=>r.trackId===t.id).length; dateAuto.value=fmtDate(new Date()); updatePacePreview(); }
function updatePacePreview(){ const t=state.tracks.find(t=>t.id===trackSelect.value); const sec=parseTimeToSec(timeInput.value); paceInput.value=isFinite(sec)?paceMinPerKm(sec, t.distanceKm):'‚Äì'; }

/* ---------------- Save Run ---------------- */
saveRunBtn.addEventListener('click', ()=>{
  const t = state.tracks.find(t=>t.id===trackSelect.value);
  const sec = parseTimeToSec(timeInput.value);
  if(!isFinite(sec)||sec<=0){ flashMsg('Enter a valid time (e.g. 09:00).', true); return; }
  const entry = { id: crypto.randomUUID(), trackId: t.id, dateISO: new Date().toISOString(), timeSec: Math.round(sec), note: (noteInput.value||'').trim() };
  state.runs.push(entry); saveJson(LS_KEYS.runs, state.runs);
  timeInput.value=''; noteInput.value=''; setRunTrackDefaults(); flashMsg('Saved ‚úÖ');
});
function flashMsg(text, err=false){ saveMsg.textContent=text; saveMsg.style.color = err ? 'var(--danger)' : 'var(--muted)'; setTimeout(()=> saveMsg.textContent='', 2200); }

/* ---------------- Stats Render ---------------- */
function renderStats(){ const t = state.tracks.find(t=>t.id===trackStatsSelect.value); if(!t) return; const goalSec = state.goals[t.id] ?? 9*60; goalInput.value = fmtSec(goalSec);
  const rows = state.runs.filter(r=>r.trackId===t.id).sort((a,b)=> new Date(a.dateISO)-new Date(b.dateISO));
  if(!rows.length){ bestTimeEl.textContent='‚Äì'; avgTimeEl.textContent='‚Äì'; lastTimeEl.textContent='‚Äì'; gapToGoalEl.textContent='‚Äì'; }
  else { const times=rows.map(r=>r.timeSec); const best=Math.min(...times); const avg=Math.round(times.reduce((x,y)=>x+y,0)/times.length); bestTimeEl.textContent=fmtSec(best); avgTimeEl.textContent=fmtSec(avg); lastTimeEl.textContent=fmtSec(rows.at(-1).timeSec); const gap=(best-goalSec); gapToGoalEl.textContent=(gap<=0?'‚úÖ ':'+')+fmtSec(Math.abs(gap)); }
  runsTableBody.innerHTML = rows.map(r=>{ const dt=fmtDate(r.dateISO); const time=fmtSec(r.timeSec); const pace=paceMinPerKm(r.timeSec, t.distanceKm); const delta=r.timeSec-goalSec; const deltaStr=(delta===0)?'0:00':(delta>0? '+'+fmtSec(delta): '‚àí'+fmtSec(Math.abs(delta))); const color = delta>0? 'style="color:var(--danger)"':'style="color:var(--accent)"'; return `<tr><td>${dt}</td><td>${time}</td><td>${pace}</td><td ${color}>${deltaStr}</td><td>${(r.note||'').replace(/</g,'&lt;')}</td></tr>`; }).join('');
  drawChart(rows, goalSec);
}

saveGoalBtn.addEventListener('click', ()=>{ const trackId=trackStatsSelect.value; const sec=parseTimeToSec(goalInput.value); if(!isFinite(sec)||sec<=0){ goalInput.focus(); goalInput.select(); return alert('Enter a valid goal (e.g. 09:00).'); } state.goals[trackId]=Math.round(sec); saveJson(LS_KEYS.goals, state.goals); renderStats(); });

/* ---------------- Chart ---------------- */
function drawChart(rows, goalSec){ const ctx=chartCanvas.getContext('2d'); const DPR= devicePixelRatio||1; const w = chartCanvas.clientWidth*DPR; const h = chartCanvas.clientHeight*DPR; if(chartCanvas.width!==w) chartCanvas.width=w; if(chartCanvas.height!==h) chartCanvas.height=h; ctx.clearRect(0,0,w,h);
  const padL=48, padR=12, padT=12, padB=36; const plotW=w-padL-padR, plotH=h-padT-padB; const times=rows.map(r=>r.timeSec); const minT=rows.length?Math.min(...times, goalSec):8*60; const maxT=rows.length?Math.max(...times, goalSec):14*60; const yMin=Math.max(0, Math.floor((minT-30)/30)*30); const yMax=Math.ceil((maxT+30)/30)*30;
  const x = i => padL + (rows.length<=1? plotW/2 : i*(plotW/(rows.length-1))); const y = s => padT + (1 - (s - yMin)/(yMax-yMin)) * plotH;
  ctx.strokeStyle='rgba(255,255,255,0.14)'; ctx.lineWidth=1*DPR; ctx.beginPath(); for(let s=yMin; s<=yMax; s+=30){ const yy=y(s); ctx.moveTo(padL,yy); ctx.lineTo(w-padR,yy);} ctx.stroke();
  ctx.fillStyle='rgba(229,231,235,0.9)'; ctx.font=`${11*DPR}px system-ui, sans-serif`; ctx.textAlign='right'; ctx.textBaseline='middle'; for(let s=yMin; s<=yMax; s+=60){ ctx.fillText(fmtSec(s), padL-6, y(s)); }
  ctx.textAlign='center'; ctx.textBaseline='top'; const step=Math.max(1, Math.floor(rows.length/6)); rows.forEach((r,i)=>{ if(i%step===0||i===rows.length-1){ ctx.fillText(fmtDate(r.dateISO), x(i), h-padB+6); }});
  ctx.strokeStyle='rgba(56,189,248,0.95)'; ctx.setLineDash([6*DPR,6*DPR]); ctx.beginPath(); ctx.moveTo(padL,y(goalSec)); ctx.lineTo(w-padR,y(goalSec)); ctx.stroke(); ctx.setLineDash([]);
  rows.forEach((r,i)=>{ const xi=x(i), yi=y(r.timeSec), yg=y(goalSec); ctx.strokeStyle = r.timeSec<=goalSec? 'rgba(34,197,94,0.65)':'rgba(239,68,68,0.65)'; ctx.lineWidth=2*DPR; ctx.beginPath(); ctx.moveTo(xi,yi); ctx.lineTo(xi,yg); ctx.stroke(); });
  if(rows.length){ ctx.strokeStyle='rgba(34,197,94,0.95)'; ctx.lineWidth=2*DPR; ctx.beginPath(); rows.forEach((r,i)=>{ const xi=x(i), yi=y(r.timeSec); if(i===0) ctx.moveTo(xi,yi); else ctx.lineTo(xi,yi);}); ctx.stroke(); }
  rows.forEach((r,i)=>{ const xi=x(i), yi=y(r.timeSec); const good=r.timeSec<=goalSec; ctx.fillStyle=good? 'rgba(34,197,94,1)':'rgba(239,68,68,1)'; ctx.beginPath(); ctx.arc(xi,yi,3.8*DPR,0,Math.PI*2); ctx.fill(); });
}

/* ---------------- Render Root ---------------- */
function render(){ const cur=Router.current(); Object.entries(views).forEach(([k,el])=> el.classList.toggle('hidden', k!==cur)); if(cur==='run'){ fillTrackSelects(); setRunTrackDefaults(); } else if(cur==='stats'){ fillTrackSelects(); renderStats(); } }

document.getElementById('homeBtn').onclick=()=>Router.go('home');
document.getElementById('runBtn').onclick =()=>Router.go('run');
document.getElementById('statsBtn').onclick=()=>Router.go('stats');

trackSelect?.addEventListener('change', setRunTrackDefaults);
trackStatsSelect?.addEventListener('change', renderStats);

timeInput?.addEventListener('input', updatePacePreview);

// boot
render();
window.addEventListener('resize', ()=>{ if(Router.current()==='stats') renderStats(); });
</script>
</body>
</html>
